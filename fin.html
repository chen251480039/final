<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>åŠ å¯†å·¥å…·ä¿®æ­£ç‰ˆ (å«RSA)</title>
    <style>
        body { font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif; max-width: 700px; margin: 2rem auto; padding: 0 1rem; color: #333; }
        h3 { border-bottom: 2px solid #eee; padding-bottom: 10px; }
        textarea, input, select { width: 100%; padding: 10px; margin-bottom: 10px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 4px; font-size: 1rem; }
        .result { background: #f8f9fa; padding: 15px; min-height: 50px; word-break: break-all; font-family: monospace; font-size: 1.1em; color: #005cc5; border: 1px solid #ddd; border-radius: 4px; }
        .control-group { margin-bottom: 15px; padding: 15px; border: 1px solid #ddd; border-radius: 8px; background-color: #fafafa; }
        label { margin-right: 15px; cursor: pointer; display: block; margin-bottom: 5px; font-weight: bold; }
        .hidden { display: none; }
        .info-text { margin: 5px 0; color: #666; font-size: 0.9em; line-height: 1.4; }
        
        /* RSAæ’ç‰ˆ  */
        .rsa-row { display: flex; gap: 15px; flex-wrap: wrap; }
        .rsa-row > div { flex: 1; min-width: 120px; }
        
        button { background-color: #007bff; color: white; border: none; padding: 10px 15px; border-radius: 4px; cursor: pointer; width: 100%; margin-top: 10px; }
        button:hover { background-color: #0056b3; }
        
        .readonly-input { background-color: #e9ecef; color: #495057; }
        .key-display { font-weight: bold; color: #d63384; }
    </style>
</head>
<body>

    <h3>æ­¥é©Ÿ 1ï¼šé¸æ“‡æ¼”ç®—æ³•</h3>
    <select id="algo" onchange="updateUI(); run();">
        <option value="caesar">å‡±è–©å¯†ç¢¼ (Caesar Cipher)</option>
        <option value="atbash">åŸƒç‰¹å·´ä»€ç¢¼ (Atbash Cipher)</option>
        <option value="rsa">RSA éå°ç¨±åŠ å¯†</option>
    </select>

    <div class="control-group">
        <strong>æ¨¡å¼ï¼š</strong><br>
        <label style="display:inline;"><input type="radio" name="mode" value="1" checked onchange="run()"> ğŸ”’ åŠ å¯†</label>
        <label style="display:inline;"><input type="radio" name="mode" value="-1" onchange="run()"> ğŸ”“ è§£å¯†</label>
    </div>

    <div id="params-caesar" class="control-group">
        <label>ä½ç§»é‡ (Key):</label>
        <input type="number" id="caesar-shift" value="3" oninput="run()">
    </div>

    <div id="params-atbash" class="control-group hidden">
        <strong>Atbash è¨­å®šï¼š</strong>
        <p class="info-text">å­—æ¯åè½‰ (Aâ†”Z, Nâ†”M)ã€‚ç„¡éœ€é¡å¤–åƒæ•¸ã€‚</p>
    </div>

    <div id="params-rsa" class="control-group hidden">
        <strong>RSA è¨­å®š (æš´åŠ›é‹ç®—ç‰ˆ)ï¼š</strong>
        <p class="info-text">è«‹å¾é¸å–®é¸æ“‡è³ªæ•¸ p èˆ‡ qã€‚ç¨‹å¼æœƒè‡ªå‹•è¨ˆç®—æ¨¡æ•¸ n èˆ‡ç§é‘° dã€‚</p>
        
        <div class="rsa-row">
            <div>
                <label>è³ªæ•¸ p:</label>
                <select id="rsa-p" onchange="calculateRSAKeys()">
                    <option value="11" selected>11</option>
                    <option value="13">13</option>
                    <option value="17">17</option>
                    <option value="19">19</option>
                    <option value="23">23</option>
                    <option value="29">29</option>
                    <option value="31">31</option>
                    <option value="37">37</option>
                    <option value="41">41</option>
                    <option value="43">43</option>
                    <option value="47">47</option>
                    <option value="53">53</option>
                    <option value="59">59</option>
                    <option value="61">61</option>
                </select>
            </div>
            <div>
                <label>è³ªæ•¸ q:</label>
                <select id="rsa-q" onchange="calculateRSAKeys()">
                    <option value="11">11</option>
                    <option value="13">13</option>
                    <option value="17" selected>17</option>
                    <option value="19">19</option>
                    <option value="23">23</option>
                    <option value="29">29</option>
                    <option value="31">31</option>
                    <option value="37">37</option>
                    <option value="41">41</option>
                    <option value="43">43</option>
                    <option value="47">47</option>
                    <option value="53">53</option>
                    <option value="59">59</option>
                    <option value="61">61</option>
                </select>
            </div>
            <div>
                <label>å…¬é‘°æŒ‡æ•¸ e:</label>
                <input type="number" id="rsa-e" value="7" oninput="calculateRSAKeys()">
            </div>
        </div>
        
        <button onclick="calculateRSAKeys()">ğŸ”„ é‡æ–°è¨ˆç®—é‡‘é‘°</button>
        <hr>
        
        <div class="rsa-row">
            <div>
                <label>æ¨¡æ•¸ N (p*q):</label>
                <input type="text" id="rsa-n" readonly class="readonly-input">
            </div>
            <div>
                <label>æ­æ‹‰å‡½æ•¸ Ï†(n):</label>
                <input type="text" id="rsa-phi" readonly class="readonly-input">
            </div>
            <div>
                <label>ç§é‘° d (ç®—å‡º):</label>
                <input type="text" id="rsa-d" readonly class="readonly-input key-display">
            </div>
        </div>
        <p class="info-text" style="color: chocolate; margin-top:10px;">
            âš ï¸ æ³¨æ„ï¼šè‹¥ p, q ä¸èƒ½ç›¸ç­‰ï¼Œå‰‡åŠ å¯†å¤±æ•—
        </p>
    </div>

    <h3>è¼¸å…¥æ–‡å­—ï¼š</h3>
    <textarea id="input" rows="4" placeholder="åœ¨æ­¤è¼¸å…¥æ–‡å­—..." oninput="run()"></textarea>
    
    <h3>çµæœï¼š</h3>
    <div id="output" class="result"></div>

    <script>
        //UI
        function updateUI() {
            const algo = document.getElementById('algo').value;
            
            document.getElementById('params-caesar').classList.add('hidden');
            document.getElementById('params-atbash').classList.add('hidden');
            document.getElementById('params-rsa').classList.add('hidden');
            
            if (algo === 'caesar') {
                document.getElementById('params-caesar').classList.remove('hidden');
            } else if (algo === 'atbash') {
                document.getElementById('params-atbash').classList.remove('hidden');
            } else if (algo === 'rsa') {
                document.getElementById('params-rsa').classList.remove('hidden');
                calculateRSAKeys(); 
            }
        }

        //ä¸»åŸ·è¡Œ
        function run() {
            const text = document.getElementById('input').value;
            const algo = document.getElementById('algo').value;
            const mode = parseInt(document.querySelector('input[name="mode"]:checked').value);
            let result = "";

            if (!text) {
                document.getElementById('output').innerText = "";
                return;
            }

            try {
                switch (algo) {
                    case 'caesar':
                        result = caesarProcess(text, mode);
                        break;
                    case 'atbash':
                        result = atbashProcess(text);
                        break;
                    case 'rsa':
                        result = rsaProcess(text, mode);
                        break;
                }
            } catch (e) {
                result = "éŒ¯èª¤: " + e.message;
            }

            document.getElementById('output').innerText = result;
        }

        //å‡±è–©æ¼”ç®—æ³•
        function caesarProcess(text, mode) {
            let shift = parseInt(document.getElementById('caesar-shift').value) || 0;
            shift = shift * mode; 
            return text.replace(/[a-zA-Z]/g, (char) => {
                const base = char <= 'Z' ? 65 : 97;
                return String.fromCharCode(((char.charCodeAt(0) - base + shift) % 26 + 26) % 26 + base);
            });
        }

        //åŸƒç‰¹å·´ä»€æ¼”ç®—æ³•
        function atbashProcess(text) {
            return text.replace(/[a-zA-Z]/g, (char) => {
                const code = char.charCodeAt(0);
                if (char <= 'Z') return String.fromCharCode(155 - code);
                else return String.fromCharCode(219 - code);
            });
        }

        //RSA
        
        
        function invs(x, y) {
            let d = 1n;
            const bx = BigInt(x);
            const by = BigInt(y);
            
            let safety = 0;
            const limit = 2000000; 

            while ((d * bx) % by !== 1n) {
                d++;
                safety++;
                if (safety > limit) {
                    throw new Error(`ç„¡æ³•è¨ˆç®—ç§é‘° dã€‚åŸå› ï¼šå…¬é‘° e (${bx}) èˆ‡ Ï†(n) (${by}) ä¸äº’è³ª (gcd != 1)ã€‚è«‹æ›´æ› e æˆ– è³ªæ•¸çµ„åˆã€‚`);
                }
            }
            return d;
        }

        // æ¨¡é‹ç®—æ¬¡æ–¹ (base^exp % mod)
        function modPow(base, exp, mod) {
            let result = 1n;
            let b = BigInt(base);
            let e = BigInt(exp);
            let m = BigInt(mod);

            while (e > 0n) {
                if (e % 2n === 1n) result = (result * b) % m;
                b = (b * b) % m;
                e /= 2n;
            }
            return result;
        }

        // è¨ˆç®—(N, Phi, D)
        function calculateRSAKeys() {
            try {
                const p = parseInt(document.getElementById('rsa-p').value);
                const q = parseInt(document.getElementById('rsa-q').value);
                const e = parseInt(document.getElementById('rsa-e').value);

                if (!p || !q || !e) return;

                const n = BigInt(p) * BigInt(q);
                const phi = BigInt(p - 1) * BigInt(q - 1);
                
                //è¨ˆç®—d
                const d = invs(e, phi);

                document.getElementById('rsa-n').value = n.toString();
                document.getElementById('rsa-phi').value = phi.toString();
                document.getElementById('rsa-d').value = d.toString();
                
                run(); 
            } catch (err) {
                document.getElementById('rsa-d').value = "è¨ˆç®—å¤±æ•—";
                document.getElementById('output').innerText = "éŒ¯èª¤: " + err.message;
            }
        }

        //RSAåŠ è§£å¯†æµç¨‹
        function rsaProcess(text, mode) {
            const nVal = document.getElementById('rsa-n').value;
            if(!nVal) return "è«‹å…ˆè¨­å®š RSA åƒæ•¸";
            const n = BigInt(nVal);
            
            if (mode === 1) { 
                //åŠ å¯†
                const e = BigInt(document.getElementById('rsa-e').value);
                let encrypted = [];
                for (let i = 0; i < text.length; i++) {
                    const charCode = text.charCodeAt(i);
                    // æ˜æ–‡ m å¿…é ˆå°æ–¼ N
                    if (BigInt(charCode) >= n) {
                        throw new Error(`å­—å…ƒ '${text[i]}' (ASCII ${charCode}) å¤§æ–¼æ¨¡æ•¸ N (${n})ï¼Œç„¡æ³•åŠ å¯†ã€‚è«‹é¸æ“‡æ›´å¤§çš„è³ªæ•¸ p æˆ– qã€‚`);
                    }
                    const c = modPow(charCode, e, n);
                    encrypted.push(c.toString());
                }
                return encrypted.join(" "); 

            } else {
                //è§£å¯†
                const d = BigInt(document.getElementById('rsa-d').value);
                const parts = text.trim().split(/\s+/); 
                let decrypted = "";
                
                for (let part of parts) {
                    if (!/^\d+$/.test(part)) continue; 
                    const m = modPow(part, d, n);
                    decrypted += String.fromCharCode(Number(m));
                }
                return decrypted;
            }
        }
        updateUI();
    </script>
</body>
</html>